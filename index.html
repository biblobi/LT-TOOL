<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMNI-MATRIX V6 | 智能核心</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff66;
            --bg-dark: #0a0a0a;
            --panel-bg: #111;
            --border-color: #333;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-dark);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #ddd;
            padding: 20px;
            padding-bottom: 80px;
        }

        .nav-deck {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px;
        }

        .nav-btn {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            color: #888;
            padding: 10px 15px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--neon-cyan);
            color: #000;
            border-color: var(--neon-cyan);
            font-weight: bold;
        }

        .container {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 800px;
            display: none;
            padding: 20px;
            animation: fade 0.2s;
        }
        .container.active { display: block; }
        @keyframes fade { from { opacity: 0.8; } to { opacity: 1; } }

        h1 {
            margin: 0 0 20px 0;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.4rem;
            color: var(--neon-cyan);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            color: #888;
            font-family: 'Share Tech Mono', monospace;
            margin: 20px 0 10px 0;
            font-size: 0.9rem;
            border-left: 2px solid var(--neon-cyan);
            padding-left: 8px;
        }

        .cyber-input {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 10px;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            margin-bottom: 10px;
            transition: border 0.2s;
        }
        .cyber-input:focus { border-color: var(--neon-cyan); }

        .btn-action {
            width: 100%;
            padding: 12px;
            background: var(--neon-cyan);
            border: none;
            color: #000;
            font-family: 'Share Tech Mono', monospace;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            text-transform: uppercase;
        }
        .btn-action:hover { opacity: 0.9; }
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--neon-pink);
            color: var(--neon-pink);
            margin-top: 5px;
        }
        .btn-secondary:hover { background: var(--neon-pink); color: #fff; }

        .upload-area {
            border: 1px dashed #444;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            position: relative;
            background: #151515;
        }
        .upload-area:hover { border-color: var(--neon-cyan); background: #1a1a1a; }

        .upload-area input[type="file"] {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .file-list { border: 1px solid #333; max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
        .file-item { padding: 8px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; font-size: 0.85rem; color: #888; }
        .control-btn { cursor: pointer; color: var(--neon-cyan); margin-left: 5px; }
        .file-controls { display: inline-flex; gap: 6px; }

        .conversion-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .conversion-table th, .conversion-table td { text-align: left; padding: 8px; border-bottom: 1px solid #222; }
        .conversion-table th { color: #888; font-family: 'Share Tech Mono'; font-size: 0.8rem; }
        .conversion-table td input { border: 1px solid #333; background: #000; color: #fff; padding: 6px; width: 100%; }

        .currency-display {
            background: #000; border: 1px solid var(--neon-green);
            padding: 15px; margin-top: 15px; text-align: center;
            color: var(--neon-green); font-family: 'Share Tech Mono', monospace;
        }

        .hf-token-edit { font-size: 0.7rem; color: #444; text-decoration: underline; cursor: pointer; margin-left: 10px; }
        .hf-token-edit:hover { color: var(--neon-cyan); }

        #bgOutput { max-width: 100%; border: 1px solid #333; margin-top: 10px; display: block; margin-left: auto; margin-right: auto; background: url('data:image/svg+xml;utf8,<svg width="10" height="10" xmlns="http://www.w3.org/2000/svg"><rect width="5" height="5" fill="%23222"/><rect x="5" y="5" width="5" height="5" fill="%23222"/></svg>'); }

        footer {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #000;
            border-top: 1px solid #333; text-align: center; padding: 10px;
            font-family: 'Share Tech Mono'; font-size: 0.8rem; color: #666;
        }
    </style>
</head>
<body>

    <div class="nav-deck">
        <button class="nav-btn active" onclick="switchTab('pdf')">PDF 聚合</button>
        <button class="nav-btn" onclick="switchTab('converter')">量子换算</button>
        <button class="nav-btn" onclick="switchTab('image')">格式转换</button>
        <button class="nav-btn" onclick="switchTab('removebg')">背景移除</button>
        <button class="nav-btn" onclick="switchTab('chat')">AI 对话</button>
        <button class="nav-btn" onclick="switchTab('currency')">实时汇率</button>
    </div>

    <!-- PDF 模块 -->
    <div id="module-pdf" class="container active">
        <h1>PDF 核心聚合</h1>
        <input type="text" id="pdfFileName" class="cyber-input" value="说明书" placeholder="输入输出文件名">
        <div class="upload-area">
            <input type="file" id="fileInput" multiple accept=".pdf, .jpg, .jpeg, .png">
            <p>点击或拖拽上传 PDF/图片</p>
        </div>
        <div class="file-list" id="fileList"></div>
        <p id="status-pdf" style="font-size:0.8rem; color:var(--neon-cyan); min-height:20px;"></p>
        <button id="mergeBtn" class="btn-action" onclick="processPdf()">合并并下载</button>
        <button id="clearBtn" class="btn-action btn-secondary" onclick="clearAllFiles()">清空列表</button>
    </div>

    <!-- 量子换算模块 -->
    <div id="module-converter" class="container">
        <h1>量子换算系统</h1>

        <div class="section-title">重量 Mass</div>
        <table class="conversion-table">
            <tr><th colspan="2">公制 Metric</th></tr>
            <tr><td>吨 Tonne (t)</td><td><input type="number" class="mass-input" data-unit="t" oninput="convertMass()"></td></tr>
            <tr><td>千克 Kilogram (kg)</td><td><input type="number" class="mass-input" data-unit="kg" oninput="convertMass()"></td></tr>
            <tr><td>克 Gram (g)</td><td><input type="number" class="mass-input" data-unit="g" oninput="convertMass()"></td></tr>
            <tr><td>毫克 Milligram (mg)</td><td><input type="number" class="mass-input" data-unit="mg" oninput="convertMass()"></td></tr>

            <tr><th colspan="2">美制 US</th></tr>
            <tr><td>磅 Pound (lb)</td><td><input type="number" class="mass-input" data-unit="lb" oninput="convertMass()"></td></tr>
            <tr><td>盎司 Ounce (oz)</td><td><input type="number" class="mass-input" data-unit="oz" oninput="convertMass()"></td></tr>
            <tr><td>短吨 US short ton (ton)</td><td><input type="number" class="mass-input" data-unit="ton_us" oninput="convertMass()"></td></tr>

            <tr><th colspan="2">英制 Imperial</th></tr>
            <tr><td>英石 Stone (st)</td><td><input type="number" class="mass-input" data-unit="st" oninput="convertMass()"></td></tr>
            <tr><td>长吨 UK long ton (ton)</td><td><input type="number" class="mass-input" data-unit="ton_uk" oninput="convertMass()"></td></tr>
        </table>

        <div class="section-title">体积 Volume</div>
        <table class="conversion-table">
            <tr><th colspan="2">公制 Metric</th></tr>
            <tr><td>立方米 Cubic meter (m3)</td><td><input type="number" class="vol-input" data-unit="m3" oninput="convertVolume()"></td></tr>
            <tr><td>升 Liter (L)</td><td><input type="number" class="vol-input" data-unit="l" oninput="convertVolume()"></td></tr>
            <tr><td>毫升 Milliliter (mL)</td><td><input type="number" class="vol-input" data-unit="ml" oninput="convertVolume()"></td></tr>

            <tr><th colspan="2">美制 US</th></tr>
            <tr><td>美制加仑 US gallon (gal)</td><td><input type="number" class="vol-input" data-unit="gal_us" oninput="convertVolume()"></td></tr>
            <tr><td>美制夸脱 US quart (qt)</td><td><input type="number" class="vol-input" data-unit="qt_us" oninput="convertVolume()"></td></tr>
            <tr><td>美制品脱 US pint (pt)</td><td><input type="number" class="vol-input" data-unit="pt_us" oninput="convertVolume()"></td></tr>
            <tr><td>美制液盎司 US fl oz (fl oz)</td><td><input type="number" class="vol-input" data-unit="floz_us" oninput="convertVolume()"></td></tr>

            <tr><th colspan="2">英制 Imperial</th></tr>
            <tr><td>英制加仑 Imperial gallon (gal)</td><td><input type="number" class="vol-input" data-unit="gal_imp" oninput="convertVolume()"></td></tr>
            <tr><td>英制夸脱 Imperial quart (qt)</td><td><input type="number" class="vol-input" data-unit="qt_imp" oninput="convertVolume()"></td></tr>
            <tr><td>英制品脱 Imperial pint (pt)</td><td><input type="number" class="vol-input" data-unit="pt_imp" oninput="convertVolume()"></td></tr>
            <tr><td>英制液盎司 Imperial fl oz (fl oz)</td><td><input type="number" class="vol-input" data-unit="floz_imp" oninput="convertVolume()"></td></tr>
        </table>

        <div class="section-title">长度 Length</div>
        <table class="conversion-table">
            <tr><th colspan="2">公制 Metric</th></tr>
            <tr><td>千米 Kilometer (km)</td><td><input type="number" class="len-input" data-unit="km" oninput="convertLength()"></td></tr>
            <tr><td>米 Meter (m)</td><td><input type="number" class="len-input" data-unit="m" oninput="convertLength()"></td></tr>
            <tr><td>厘米 Centimeter (cm)</td><td><input type="number" class="len-input" data-unit="cm" oninput="convertLength()"></td></tr>
            <tr><td>毫米 Millimeter (mm)</td><td><input type="number" class="len-input" data-unit="mm" oninput="convertLength()"></td></tr>

            <tr><th colspan="2">美制/英制 US/Imperial</th></tr>
            <tr><td>英寸 Inch (in)</td><td><input type="number" class="len-input" data-unit="in" oninput="convertLength()"></td></tr>
            <tr><td>英尺 Foot (ft)</td><td><input type="number" class="len-input" data-unit="ft" oninput="convertLength()"></td></tr>
            <tr><td>码 Yard (yd)</td><td><input type="number" class="len-input" data-unit="yd" oninput="convertLength()"></td></tr>
            <tr><td>英里 Mile (mi)</td><td><input type="number" class="len-input" data-unit="mi" oninput="convertLength()"></td></tr>
            <tr><td>海里 Nautical mile (nmi)</td><td><input type="number" class="len-input" data-unit="nmi" oninput="convertLength()"></td></tr>
        </table>

        <div class="section-title">温度 Temperature</div>
        <table class="conversion-table">
            <tr><td>摄氏 Celsius (C)</td><td><input type="number" class="temp-input" data-unit="c" oninput="convertTemperature()"></td></tr>
            <tr><td>华氏 Fahrenheit (F)</td><td><input type="number" class="temp-input" data-unit="f" oninput="convertTemperature()"></td></tr>
            <tr><td>开尔文 Kelvin (K)</td><td><input type="number" class="temp-input" data-unit="k" oninput="convertTemperature()"></td></tr>
        </table>
    </div>

    <!-- 格式转换 -->
    <div id="module-image" class="container">
        <h1>图像嬗变</h1>
        <div class="upload-area">
            <input type="file" id="imgConvertInput" accept="image/*">
            <p>上传图片</p>
        </div>
        <select id="imgTargetFormat" class="cyber-input">
            <option value="image/jpeg">JPG</option>
            <option value="image/png">PNG</option>
            <option value="image/webp">WEBP</option>
        </select>
        <button class="btn-action" onclick="convertImage()">执行转换并下载</button>
        <p id="status-img" style="text-align:center; color:var(--neon-cyan); margin-top:10px;"></p>
    </div>

    <!-- 背景移除 -->
    <div id="module-removebg" class="container">
        <h1>背景移除</h1>

        <select id="bgEngine" class="cyber-input">
            <option value="auto">自动（WebGPU 优先）</option>
            <option value="wasm">兼容（WASM/CPU）</option>
        </select>

        <div class="upload-area">
            <input type="file" id="bgInput" accept="image/*">
            <p>点击或拖拽上传图片去背景（本地推理，不上传服务器）</p>
        </div>

        <button id="bgProcessBtn" class="btn-action" onclick="processRemoveBg()">执行去背景</button>
        <p id="status-bg" style="text-align:center; color:var(--neon-cyan); margin-top:10px;"></p>
        <div id="bgResult" style="display:none; text-align:center;">
            <img id="bgOutput" alt="Result">
            <br><br>
            <a id="bgDownload" class="btn-action" style="display:inline-block; width:auto; padding:8px 20px;">下载</a>
        </div>
    </div>

    <!-- AI 对话 -->
    <div id="module-chat" class="container">
        <h1>AI 核心对话 <span class="hf-token-edit" onclick="toggleChatKey()">设置 Key</span></h1>

        <div id="chatKeyContainer" style="display:none;">
            <input type="password" id="chatApiKey" class="cyber-input" placeholder="输入 OpenRouter API Key">
            <button class="btn-action btn-secondary" onclick="saveChatKey()">保存 Key</button>
        </div>

        <div style="display:flex; gap:10px;">
            <select id="chatModel" class="cyber-input" style="flex:2">
                <option value="xiaomi/mimo-v2-flash:free">MiMo-V2-Flash (free)</option>
                <option value="deepseek/deepseek-r1-0528:free">DeepSeek-R1-0528 (free)</option>
                <option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3 70B (free)</option>
            </select>
            <select id="chatRole" class="cyber-input" style="flex:1">
                <option value="default">默认对话</option>
                <option value="coder">代码专家</option>
                <option value="translator">专业翻译</option>
                <option value="writer">文案写作</option>
            </select>
        </div>

        <textarea id="chatBox" class="cyber-input" rows="6" placeholder="输入指令..."></textarea>
        <div style="display:flex; gap:10px;">
            <button class="btn-action" onclick="sendMessage()" style="flex:2">发送</button>
            <button class="btn-action btn-secondary" onclick="clearChat()" style="flex:1">清空</button>
        </div>
        <p id="chatStatus" style="text-align:center; color:var(--neon-cyan); margin-top:5px;"></p>
    </div>

    <!-- 实时汇率 -->
    <div id="module-currency" class="container">
        <h1>实时汇率</h1>
        <div style="display:flex; gap:10px;">
            <select id="sourceCurrency" class="cyber-input" onchange="updateCurrencyDisplay()">
                <option value="CNY">CNY 人民币</option>
                <option value="USD">USD 美元</option>
                <option value="EUR">EUR 欧元</option>
                <option value="JPY">JPY 日元</option>
                <option value="HKD">HKD 港币</option>
                <option value="GBP">GBP 英镑</option>
            </select>
            <select id="targetCurrency" class="cyber-input" onchange="updateCurrencyDisplay()">
                <option value="USD">USD 美元</option>
                <option value="CNY">CNY 人民币</option>
                <option value="EUR">EUR 欧元</option>
                <option value="JPY">JPY 日元</option>
                <option value="HKD">HKD 港币</option>
                <option value="GBP">GBP 英镑</option>
            </select>
        </div>

        <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-top:15px;">
            <input type="number" id="amountInput" class="cyber-input" style="text-align:right" placeholder="金额" oninput="calcCurrency('amount')">
            <span style="font-family:'Share Tech Mono'; color:#888; font-size:1.2rem;">↔</span>
            <input type="number" id="resultInput" class="cyber-input" placeholder="结果" oninput="calcCurrency('result')">
        </div>

        <button class="btn-action" onclick="fetchRates()">>>> 刷新汇率数据</button>

        <div class="currency-display" id="currencyInfo">
            <div id="rateDisplay">点击刷新按钮获取实时汇率</div>
            <div id="updateTime" style="font-size:0.7rem; color:#666; margin-top:5px;"></div>
        </div>
    </div>

    <footer>SYSTEM CORE DESIGNED BY CHE RUI</footer>

<script>
    // 配置区域
    const OPENROUTER_BASE_URL = 'https://openrouter.ai/api/v1';
    const DEFAULT_OPENROUTER_KEY = '';
    let currentOpenRouterKey = localStorage.getItem('openrouter_key') || DEFAULT_OPENROUTER_KEY;

    let liveRates = {};
    let lastBase = "CNY";

    function switchTab(name) {
        document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('module-' + name).classList.add('active');
        const index = ['pdf','converter','image','removebg','chat','currency'].indexOf(name);
        if(index >= 0) document.querySelectorAll('.nav-btn')[index].classList.add('active');
        if(name === 'currency' && Object.keys(liveRates).length === 0) fetchRates();
        if(name === 'removebg' && window.preloadRemoveBgModel) window.preloadRemoveBgModel();
    }

    /* --- PDF 模块 --- */
    let pdfFiles = [];
    let autoMergedOnce = false;
    document.getElementById('fileInput').addEventListener('change', e => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        const isFirstUpload = pdfFiles.length === 0;
        pdfFiles = pdfFiles.concat(files);
        if (isFirstUpload) sortPdfFilesByName();
        updatePdfList();
        if (isFirstUpload && !autoMergedOnce) {
            autoMergedOnce = true;
            processPdf();
        } else {
            document.getElementById('status-pdf').innerText = '列表已更新，点击“合并并下载”';
        }
    });
    function sortPdfFilesByName() {
        pdfFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
    }
    function updatePdfList() {
        const list = document.getElementById('fileList');
        list.innerHTML = '';
        pdfFiles.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `<span>${i+1}. ${f.name}</span>
                <span class="file-controls">
                    <span class="control-btn" onclick="movePdf(${i}, -1)" title="上移">▲</span>
                    <span class="control-btn" onclick="movePdf(${i}, 1)" title="下移">▼</span>
                    <span class="control-btn" onclick="removePdf(${i})" title="移除">✕</span>
                </span>`;
            list.appendChild(div);
        });
    }
    window.movePdf = (i, dir) => {
        const target = i + dir;
        if(target < 0 || target >= pdfFiles.length) return;
        const [item] = pdfFiles.splice(i, 1);
        pdfFiles.splice(target, 0, item);
        updatePdfList();
    };
    window.removePdf = (i) => { pdfFiles.splice(i, 1); updatePdfList(); };
    window.clearAllFiles = () => {
        pdfFiles = [];
        autoMergedOnce = false;
        updatePdfList();
        document.getElementById('status-pdf').innerText = '';
    };
    async function processPdf() {
        if(pdfFiles.length === 0) {
            document.getElementById('status-pdf').innerText = '请先添加文件';
            return;
        }
        document.getElementById('status-pdf').innerText = '正在聚合...';
        try {
            const { PDFDocument } = PDFLib;
            const mergedPdf = await PDFDocument.create();
            for (let file of pdfFiles) {
                const arrayBuffer = await file.arrayBuffer();
                if (file.type === 'application/pdf') {
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    pages.forEach(p => mergedPdf.addPage(p));
                } else {
                    let img = file.type === 'image/png' ? await mergedPdf.embedPng(arrayBuffer) : await mergedPdf.embedJpg(arrayBuffer);
                    const page = mergedPdf.addPage([img.width, img.height]);
                    page.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
                }
            }
            const bytes = await mergedPdf.save();
            let name = document.getElementById('pdfFileName').value.trim() || "说明书";
            if(!name.endsWith('.pdf')) name += ".pdf";
            download(bytes, name, "application/pdf");
            document.getElementById('status-pdf').innerText = '聚合完成，已下载';
        } catch(e) {
            document.getElementById('status-pdf').innerText = '错误: ' + e.message;
        }
    }

    /* --- 量子换算 --- */
    function fmtNumber(n) {
        if (!Number.isFinite(n)) return "";
        let s = n.toFixed(8);
        s = s.replace(/\.?0+$/g, "");
        return s;
    }

    function convertByFactor(selector, factorToBase) {
        const inputs = Array.from(document.querySelectorAll(selector));
        const activeEl = document.activeElement;
        const sourceEl = inputs.find(el => el === activeEl) || inputs.find(el => el.value !== "" && !Number.isNaN(parseFloat(el.value)));
        if (!sourceEl) return;

        const sourceUnit = sourceEl.dataset.unit;
        const sourceVal = parseFloat(sourceEl.value);
        if (Number.isNaN(sourceVal)) return;

        const baseVal = sourceVal * factorToBase[sourceUnit];
        inputs.forEach(input => {
            if (input === activeEl) return;
            const unit = input.dataset.unit;
            input.value = fmtNumber(baseVal / factorToBase[unit]);
        });
    }

    const MASS = {
        t: 1000,
        kg: 1,
        g: 0.001,
        mg: 0.000001,
        lb: 0.45359237,
        oz: 0.028349523125,
        st: 6.35029318,
        ton_us: 907.18474,
        ton_uk: 1016.0469088
    };

    const VOL = {
        m3: 1000,
        l: 1,
        ml: 0.001,
        gal_us: 3.785411784,
        qt_us: 0.946352946,
        pt_us: 0.473176473,
        floz_us: 0.0295735295625,
        gal_imp: 4.54609,
        qt_imp: 1.1365225,
        pt_imp: 0.56826125,
        floz_imp: 0.0284130625
    };

    const LEN = {
        km: 1000,
        m: 1,
        cm: 0.01,
        mm: 0.001,
        in: 0.0254,
        ft: 0.3048,
        yd: 0.9144,
        mi: 1609.344,
        nmi: 1852
    };

    window.convertMass = () => convertByFactor('.mass-input', MASS);
    window.convertVolume = () => convertByFactor('.vol-input', VOL);
    window.convertLength = () => convertByFactor('.len-input', LEN);

    window.convertTemperature = () => {
        const inputs = Array.from(document.querySelectorAll('.temp-input'));
        const activeEl = document.activeElement;
        const sourceEl = inputs.find(el => el === activeEl) || inputs.find(el => el.value !== "" && !Number.isNaN(parseFloat(el.value)));
        if (!sourceEl) return;

        const sourceVal = parseFloat(sourceEl.value);
        if (Number.isNaN(sourceVal)) return;

        let celsius = null;
        const unit = sourceEl.dataset.unit;
        if (unit === 'c') celsius = sourceVal;
        if (unit === 'f') celsius = (sourceVal - 32) / 1.8;
        if (unit === 'k') celsius = sourceVal - 273.15;
        if (celsius === null) return;

        inputs.forEach(input => {
            if (input === activeEl) return;
            const u = input.dataset.unit;
            if (u === 'c') input.value = fmtNumber(celsius);
            if (u === 'f') input.value = fmtNumber(celsius * 1.8 + 32);
            if (u === 'k') input.value = fmtNumber(celsius + 273.15);
        });
    };

    /* --- 图片转格式 --- */
    document.getElementById('imgConvertInput').addEventListener('change', function(){
        if(this.files.length) document.getElementById('status-img').innerText = `已选择: ${this.files[0].name}`;
    });
    window.convertImage = () => {
        const file = document.getElementById('imgConvertInput').files[0];
        if(!file) return alert('请先上传图片');
        const format = document.getElementById('imgTargetFormat').value;
        const status = document.getElementById('status-img');
        status.innerText = "处理中...";
        const img = new Image();
        const reader = new FileReader();
        reader.onload = e => {
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                if(format === 'image/jpeg') { ctx.fillStyle="#FFF"; ctx.fillRect(0,0,canvas.width,canvas.height); }
                ctx.drawImage(img, 0, 0);
                canvas.toBlob(blob => {
                    let ext = format.split('/')[1];
                    download(blob, `convert.${ext}`, format);
                    status.innerText = "下载完成";
                }, format, 0.9);
            };
        };
        reader.readAsDataURL(file);
    };

    window.toggleChatKey = () => {
        const div = document.getElementById('chatKeyContainer');
        const input = document.getElementById('chatApiKey');
        input.value = currentOpenRouterKey || '';
        div.style.display = div.style.display === 'none' ? 'block' : 'none';
    };
    window.saveChatKey = () => {
        const val = document.getElementById('chatApiKey').value.trim();
        if (val) {
            currentOpenRouterKey = val;
            localStorage.setItem('openrouter_key', val);
            alert('Key 已保存');
        } else {
            currentOpenRouterKey = '';
            localStorage.removeItem('openrouter_key');
        }
        document.getElementById('chatKeyContainer').style.display = 'none';
    };

    /* --- AI 聊天 --- */
    window.sendMessage = async () => {
        const box = document.getElementById('chatBox');
        const model = document.getElementById('chatModel').value;
        const role = document.getElementById('chatRole').value;
        const status = document.getElementById('chatStatus');
        const prompt = box.value.trim();
        if(!prompt) return;

        const apiKey = currentOpenRouterKey || document.getElementById('chatApiKey').value.trim();
        if (!apiKey) {
            status.innerText = '请先设置 OpenRouter API Key';
            return;
        }

        let systemPrompt = "You are a helpful assistant.";
        if(role === 'coder') systemPrompt = "You are an expert software engineer. Output clean, efficient code with comments.";
        if(role === 'translator') systemPrompt = "You are a professional translator. Translate the user's text accurately.";
        if(role === 'writer') systemPrompt = "You are a creative writer. Write engaging content based on the user's topic.";

        const messages = [
            { role: "system", content: systemPrompt },
            { role: "user", content: prompt }
        ];

        status.innerText = "思考中...";
        try {
            const headers = {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
                'X-Title': 'OMNI-MATRIX'
            };
            const origin = (location.origin && location.origin !== 'null') ? location.origin : '';
            if (origin) headers['HTTP-Referer'] = origin;

            const res = await fetch(`${OPENROUTER_BASE_URL}/chat/completions`, {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    model,
                    messages,
                    stream: false
                })
            });

            if (!res.ok) {
                const errText = await res.text();
                throw new Error(errText || `HTTP ${res.status}`);
            }

            const data = await res.json();
            const reply = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
            if(reply) {
                box.value = `\n[AI]: ${reply}\n-------------------\n` + box.value;
                status.innerText = "完成";
            } else {
                throw new Error((data && data.error && data.error.message) || "Empty response");
            }
        } catch(e) {
            status.innerText = "错误: " + (e && e.message ? e.message : String(e));
        }
    };
    window.clearChat = () => { document.getElementById('chatBox').value = ''; document.getElementById('chatStatus').innerText = ''; };

    /* --- 实时汇率 (双向逻辑) --- */
    async function fetchRates() {
        const btn = document.querySelector('button[onclick="fetchRates()"]');
        btn.innerText = "正在更新...";
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/CNY');
            const data = await res.json();
            if(data.result === "success") {
                liveRates = data.rates;
                lastBase = data.base_code;
                document.getElementById('updateTime').innerText = "更新时间: " + new Date().toLocaleTimeString();
                document.getElementById('currencyInfo').style.borderColor = "var(--neon-green)";
                document.getElementById('rateDisplay').innerText = `数据源: ExchangeRate-API`;
                calcCurrency('amount');
            } else {
                throw new Error("数据获取失败");
            }
        } catch(e) {
            document.getElementById('rateDisplay').innerText = "API 连接失败";
            console.error(e);
        } finally {
            btn.innerText = ">>> 刷新汇率数据";
        }
    }

    window.updateCurrencyDisplay = () => calcCurrency('amount');

    window.calcCurrency = (sourceInputId) => {
        const source = document.getElementById('sourceCurrency').value;
        const target = document.getElementById('targetCurrency').value;
        const rateTarget = liveRates[target];
        const rateSource = liveRates[source];

        if(!rateTarget || !rateSource) return;

        const amountEl = document.getElementById('amountInput');
        const resultEl = document.getElementById('resultInput');

        if(sourceInputId === 'amount') {
            const val = parseFloat(amountEl.value);
            if(!isNaN(val)) {
                const valInBase = val / rateSource;
                resultEl.value = (valInBase * rateTarget).toFixed(4);
            } else {
                resultEl.value = "";
            }
        } else {
            const val = parseFloat(resultEl.value);
            if(!isNaN(val)) {
                const valInBase = val / rateTarget;
                amountEl.value = (valInBase * rateSource).toFixed(4);
            } else {
                amountEl.value = "";
            }
        }
    };

    /* --- 工具 --- */
    function download(data, filename, type) {
        const blob = data instanceof Blob ? data : new Blob([data], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1500);
    }
</script>

<!-- 背景移除：Transformers.js WebGPU 优先 -->
<script type="module">
  import { pipeline, env, RawImage } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3/+esm';

  env.allowLocalModels = false;

  const MODEL_ID = 'briaai/RMBG-1.4';

  let segmenter = null;
  let loading = null;
  let lastObjectURL = null;
  let lastDevice = null;

  function setStatus(msg) {
    const el = document.getElementById('status-bg');
    if (el) el.innerText = msg;
  }

  function pickDevice() {
    const mode = document.getElementById('bgEngine')?.value || 'auto';
    if (mode === 'wasm') return 'wasm';
    const secure = location.protocol === 'https:' || location.hostname === 'localhost';
    const hasWebGPU = typeof navigator !== 'undefined' && 'gpu' in navigator;
    return (secure && hasWebGPU) ? 'webgpu' : 'wasm';
  }

  function resetEngine() {
    segmenter = null;
    loading = null;
    lastDevice = null;
  }

  async function ensureLoaded() {
    const device = pickDevice();
    if (segmenter && device === lastDevice) return segmenter;
    if (loading) return loading;

    loading = (async () => {
      setStatus(`加载模型中... (${device})`);
      segmenter = await pipeline('image-segmentation', MODEL_ID, {
        device,
        dtype: device === 'webgpu' ? 'fp16' : 'fp32'
      });
      lastDevice = device;
      setStatus(`模型已就绪 (${device})`);
      return segmenter;
    })();

    return loading;
  }

  document.getElementById('bgEngine').addEventListener('change', () => {
    resetEngine();
    setStatus('引擎已切换');
  });

  document.getElementById('bgInput').addEventListener('change', function () {
    const f = this.files && this.files[0];
    setStatus(f ? `已选择: ${f.name}` : '');
    document.getElementById('bgResult').style.display = 'none';
  });

  window.preloadRemoveBgModel = ensureLoaded;

  window.processRemoveBg = async () => {
    const file = document.getElementById('bgInput').files[0];
    const btn = document.getElementById('bgProcessBtn');
    if (!file) { setStatus('请上传图片'); return; }

    btn.disabled = true;
    btn.style.opacity = '0.7';

    try {
      const seg = await ensureLoaded();
      setStatus('分析中...');

      const image = await RawImage.fromBlob(file);
      const result = await seg(image);

      if (!Array.isArray(result) || result.length === 0) {
        throw new Error('未得到分割结果');
      }

      let best = result[0];
      for (const r of result) {
        if ((r.score || 0) > (best.score || 0)) best = r;
      }

      if (!best.mask) throw new Error('分割结果缺少 mask');
      let mask = best.mask;
      if (mask.width !== image.width || mask.height !== image.height) {
        mask = await mask.resize(image.width, image.height);
      }

      const output = await image.composite(mask, 'multiply');
      const canvas = output.toCanvas();
      const blob = await new Promise((resolve, reject) => {
        canvas.toBlob((b) => b ? resolve(b) : reject(new Error('导出 PNG 失败')), 'image/png');
      });

      if (lastObjectURL) URL.revokeObjectURL(lastObjectURL);
      lastObjectURL = URL.createObjectURL(blob);

      document.getElementById('bgOutput').src = lastObjectURL;
      const dl = document.getElementById('bgDownload');
      dl.href = lastObjectURL;
      dl.download = 'no-bg.png';

      document.getElementById('bgResult').style.display = 'block';
      setStatus('处理成功（WebGPU 优先）');
    } catch (e) {
      setStatus('失败: ' + (e && e.message ? e.message : String(e)));
    } finally {
      btn.disabled = false;
      btn.style.opacity = '1';
    }
  };
</script>
</body>
</html>
